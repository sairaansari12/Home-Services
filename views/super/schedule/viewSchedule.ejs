<!-- AUI Framework -->
<!DOCTYPE html>
    <html>
   <%-include ('../partials/header')%>
    <body style="overflow: hidden;">
        

       

        <div id="page-wrapper" class="demo-example">

           

            <!-- #page-header -->

            <%-include ('../partials/side_bar')%>
            <!-- #page-sidebar -->
            <div id="page-content-wrapper">
                <div id="page-title">


    <div class="bg-gray text-transform-upr font-size-15 font-bold primary-font pad10A" >Edit Schedule</div>

    

                </div>
                   <!-- #page-title -->
<div id="page-content">


<%-include ('../partials/flashMessage')%>



    <div class="large-box col-md-10">
            

                <!-- <form id="demo-form" action=""  method="" /> -->




                <form  role="form" onsubmit="return false"  class="col-md-12"  id="adduser" >
                    <input type="hidden"  name="scheduleId" id="scheduleId"   <%if(data){%> value="<%-data.id%>"  <%}%>/>
                    <input type="hidden"  name="dayParts" id="dayParts"   value="mon"/>



                    
                    
                    <div class="form-row">
                        <div class="form-label col-md-4">
                            <label for="">
                                Duration:
                                <span class="required">*</span>
                            </label>
                        </div>
                        <div class="bootstrap-timepicker dropdown col-lg-4">
                            <span clas>Start Time:</span> 
                            <input class="timepicker input"  <%if(data){%>  value="<%-data.startTime%>"  <%}%> id="fromTime"  data-required="true" onchange="getTimeSlots()"  name="startTime" type="text" />

                        </div>

                        <div class="form-input bootstrap-timepicker dropdown col-lg-3">
                            End Time:
                            <input class="timepicker input"   <%if(data){%> value="<%-data.endTime%>" <%}%>  id="toTime"  data-required="true" onchange="getTimeSlots()" name="endTime" type="text" />
                        </div>
                    </div>

                   
                    <!-- <div class="form-row">

                            <div class="form-label col-md-4"><label for="">Break Time:</label></div>

                            <div class="form-row col-md-7" id="breakSlots">
                           
                           
                            <div class="form-input" id="row_0">
                            <div class="bootstrap-timepicker dropdown col-md-5"> Start Time:
                                <input class="timepicker" id="breakFTime_0" onchange="getTimeSlots()" name="fromBTime0" type="text" /></div>
                            <div class="form-input bootstrap-timepicker dropdown col-md-5">End Time:
                                <input class="timepicker input"  id="breakTTime_0"  name="toBTime0" type="text" />
                            </div>
                            </div> 


                           //breakSolt Row End -->
 
<!-- </div>
<i class="col-md-1 glyph-icon icon-plus font-size-20"  onclick="addMoreBreak()" style="margin-top:15px"></i>

                          

                            
                      
                      
        
                        </div>
                    </div>  -->


                  
                    <div class="form-row">
                        <div class="form-label col-md-4">
                            <label for="">
                                Turnaround (minutes):
                                <span class="required">*</span>
                            </label>
                        </div>
                        <div class="form-input col-md-8">
                        <input    value="60" data-type="number" data-required="true"    onchange="getTimeSlots()" id="turnaround" name="turnaround" />
                        </div>
                    </div>
                    


              <div class="form-row">
                        <div class="form-label col-md-4">
                            <label for="">
                               Time Slots:
                            </label>
                        </div>
        
                        
                    <div class="tabs col-md-8 font-size-12">
                       
                        <div class="form-checkbox-radio col-md-1" >
                            <input type="checkbox" class="custom-checkbox" name="checkedMonFri"  />
                            <label for="">Mon-Fri</label>
                            </div>

                            <ul >

                        
                                <li>
                                    <a   href="#tabs-accordion-1" onclick="getDaydata('mon')" title="Tab 1">
                <i class="glyph-icon icon-calendar small"></i>
        Mon
                                    </a>
                                </li>
                                <li>
                                    <a  href="#tabs-accordion-1" onclick="getDaydata('tue')" title="Tab 2">
                                        <i class="glyph-icon icon-calendar small"></i>
                                        Tue
                                    </a>
                                </li>
                                <li class="mobile-hidden">
                                    <a   href="#tabs-accordion-1"  onclick="getDaydata('wed')"  title="Tab 3">
                                        <i class="glyph-icon icon-calendar small"></i>
                                        Wed
                                    </a>
                                </li>
                                <li class="mobile-hidden">
                                    <a   href="#tabs-accordion-1" onclick="getDaydata('thu')" title="Tab 4">
                                        <i class="glyph-icon icon-calendar small"></i>
                                        Thu
                                    </a>
                                </li>
                                <li class="mobile-hidden">
                                    <a    href="#tabs-accordion-1" onclick="getDaydata('fri')" title="Tab 4">
                                        <i class="glyph-icon icon-calendar small"></i>
                                        Fri
                                    </a>
                                </li>

                                <li class="mobile-hidden">
                                    <a   href="#tabs-accordion-1"onclick="getDaydata('sat')" title="Tab 4">
                                        <i class="glyph-icon icon-calendar small"></i>
                                         Sat
                                    </a>
                                </li>
                                <li class="mobile-hidden">
                                    <a   href="#tabs-accordion-1" onclick="getDaydata('sun')" title="Tab 4">                <i class="glyph-icon icon-calendar small"></i>
                                        Sun
                                    </a>
                                </li>

                            </ul>

                            
                        <div id="justified-tabs-1">
                            <div class="form-row" id="timeSlots">
                    
                                <div class="form-input col-md-12">
                                 <div class="form-label col-md-3 font-size-11"><label> Time Slot:</label></div>
                                <div class="form-label col-md-3 "><label> Time Slot:</label></div>
                                 <div class="form-label col-md-3 font-size-11"><label>Quantity:</label></div>
                                <input class="col-md-2" data-required="true"  data-type="number" />
                              </div>
        
        
        
        
        
        </div>
        
                        </div>
                        
                        
                       
                    </div>
                </div>

                 

                  

                    <div class="divider"></div>
                    <div class="form-row">
                        <input type="hidden" name="superhidden" id="superhidden" />
                        <div class="form-input col-md-8 col-md-offset-6">
                            <!-- //onclick="javascript:$(&apos;#demo-form&apos;).parsley( &apos;validate&apos; );" -->
                            <!-- onclick="javascript:$('#adduser').parsley('validate' );"  -->
                            <button  type="button" onclick="window.history.back();"   class="btn ui-state-default medium bg-red mrg15R">
                                <span class="button-content">Cancel</span>
                            </button>
                            <button  type="submit" class="btn ui-state-default medium  primary-bg">
                                <span class="button-content">Submit</span>
                            </button>
                            </div>
                    </div>

                </form>

        </div>

       
  



                	</div><!-- #page-content -->
            </div><!-- #page-main -->
        </div><!-- #page-wrapper -->

    </body>
</html>


<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.23.0/moment.min.js"></script>

<script type="text/javascript">

var breakRow=0
var slotRow=0
var breakTime=[]
var times=[]

$(document).on('focus',".timepicker", function(){
    $(this).timepicker();
});

var count=0
getDaydata('mon')


      $('#adduser').submit( function() {
       
        var tempform = $('#adduser');

            tempform .parsley('validate' );

            if(tempform.parsley('isValid' ))
            {


  
if(times.length==0)

{
    showToastError("Please Select Slots ,to get slots choose correct from and to time")

}
else{

            var form_data = new FormData(tempform[0]);
            $("#loading1").show();

            $.ajax({
                type: 'POST',
                url: '<%-superadminpath%>schedule/addupdate',
                dataType: 'json',
                data:form_data ,
                contentType:false,
                cache:false,
                processData:false,
                success: function (response) {
                    $(".overlay").hide();
                    if (response.code == 200) {
                  
                        showToastSuccess(response.message)

                  window.location.reload()                       
                    } else {
                        showToastError(response.message)
                    }
                },

                error: function(response)
                {
                   var errorResponse=JSON.parse(response.responseText)
                   showToastError(errorResponse.message)


                }
            });
        }
    }
      });
    



      function breakTimeArray()
{
    breakTime=[]
    for(var j=0;j<=breakRow;j++)
         {
var newArr=[];

  
var fromBreak=$('#breakFTime_'+j).val()

var ToBreak=$('#breakTTime_'+j).val()

newArr.push(fromBreak)
newArr.push(ToBreak)

breakTime.push([newArr])
         }
       //  console.log(breakTime)

}




      function getTimeSlots(permanentSlots,slots)
      {
        
       // breakTimeArray();

        var startTime=$('#fromTime').val()
         var endTime=$('#toTime').val()
         var turnaround=$('#turnaround').val()

         

        var x = {
    nextSlot:turnaround,
    // breakTime: [
    //     ['05:30 PM', '06:00 PM']
    // ],
    breakTime: breakTime,
    startTime: startTime,
    endTime: endTime
};




var slotTime = moment(x.startTime, "hh:mm a");
var endTime = moment(x.endTime, "hh:mm a");



function isInBreak(slotTime, breakTimes) {
    return breakTimes.some((br) => {

        var breakTime= br.toString().split(",")

      return slotTime >= moment(breakTime[0], "hh:mm a") && slotTime < moment(breakTime[1], "hh:mm a");
  });
}

 times = [];
var timeSlots=""
slotRow=0
var dataValue=null

if(slots!=null)
{
    dataValue=JSON.parse(permanentSlots)
dataValueSlots=JSON.parse(slots)
}  

while (slotTime < endTime)
{
  if (!isInBreak(slotTime, x.breakTime)) {
timeSlots=timeSlots+ '<div class="form-input col-md-12">'+
    '<input type="hidden" value="'+slotTime.format("hh:mm A")+'"  name= "slotsTime" id ="timeValue_'+slotRow+'">'+
'                       <div class="form-label col-md-2 font-size-16"><label> '+ slotTime.format("hh:mm A")+'</label></div>'+
'                        <div class="form-label col-md-3 font-size-11"><label>Maximum Bookings:</label></div>';

// '<input class="form-input col-md-5" data-required="true"  value="0" id="slotQuantity_'+slotRow+'"  data-type="number" />'+

     var timeSlots1="";
 if(dataValue && dataValue.length>0 && dataValue[slotRow] )
      {
 timeSlots=timeSlots+'<div class="col-md-2"> <input  data-required="true"  oninput="remainingSlots('+slotRow+','+dataValue[slotRow].bookings+','+(dataValue[slotRow].bookings-dataValueSlots[slotRow].bookings)+')"   name= "slotsQuantity"  value="'+dataValue[slotRow].bookings+'" id="slotQuantity_'+slotRow+'"  data-type="number" /></div> ';
 timeSlots1='<input class="col-md-1"   readonly  name= "slotsQuantity1"  value="'+dataValueSlots[slotRow].bookings+'" id="slotQuantity1_'+slotRow+'"  data-type="number" /> ';
  }
 else{

 timeSlots=timeSlots+'<div class="col-md-2"><input data-required="true"  name= "slotsQuantity"   value="0"  id="slotQuantity_'+slotRow+'"  data-type="number" /></div>';
 timeSlots1='<input class="form-input  col-md-1" data-required="true"  readonly  name= "slotsQuantity1"   value="0" id="slotQuantity1_'+slotRow+'"  data-type="number" />';

}


timeSlots=timeSlots+'<div class="form-label col-md-3 font-size-11"><label> Remaining Today:</label></div>';
timeSlots=timeSlots+timeSlots1+'</div>'
     times.push(slotTime.format("hh:mm"));
     slotRow++;

  }
  slotTime = slotTime.add(x.nextSlot, 'minutes');
}


$('#timeSlots').html(timeSlots)
      }



      function saveSlot()
      {

       
      var tempform = $('#adduser');
      tempform .parsley('validate' );

           if(tempform.parsley('isValid' ))
           {


 
if(times.length==0)

{
   showToastError("Please Select Slots ,to get slots choose correct from and to time")

}
else{

           var form_data = new FormData(tempform[0]);

           $.ajax({
               type: 'POST',
               url: '<%-superadminpath%>schedule/addupdate',
               dataType: 'json',
               data:form_data ,
               contentType:false,
               cache:false,
               processData:false,
               success: function (response) {
                   if (response.code == 200) {
                 

                   } else {
                   }
               },

               error: function(response)
               {
                  var errorResponse=JSON.parse(response.responseText)


               }
           });
       }
   }
   
   

      }

      function remainingSlots(rowNo,prevVal,diff)
      {

        setTimeout(function(){ 

        var newValue=$('#slotQuantity_'+rowNo).val()
        var prevval=prevVal
var thisRowVal= $('#slotQuantity1_'+rowNo).val()

//var diff=prevval-thisRowVal
var newVal=newValue-diff

if(newVal<0 ) {
    $('#slotQuantity_'+rowNo).val(prevval)
    alert("this value can't be less than remaining bookings")
}
    else $('#slotQuantity1_'+rowNo).val(newVal)
        
},800);
      }

function getDaydata(day)
{

if(count>0)saveSlot()
count++;


$('#loading1').show();

setTimeout(function(){ 
    $('#dayParts').val(day)

    $.ajax({
            type: 'POST',
            url: '<%-superadminpath%>schedule/getSlots',
            dataType: 'json',
            data: {'dayParts':day},
            success: function (response) {
                $('#loading1').hide();

                var dataAppend=null
                var data=response.body
                if (response.code == '200') {
                   if(data==null)
                   getTimeSlots(null,null);

                else {
                 $('#fromTime').val(data.startTime)
                 $('#toTime').val(data.endTime)
                 $('#turnaround').val(data.turnaround)
                 $('#fromDate').val(data.fromDate)
                $('#toDate').val(data.toDate)
                getTimeSlots(data.permanentSlots,data.slots);


                }

                    }

            
                
            },

            error :function(response)
            {                $('#loading1').hide();

                showToastError(response.message)

            }
        });
    

}, 1000);

}


   





    </script>

